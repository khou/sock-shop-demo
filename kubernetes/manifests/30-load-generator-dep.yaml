# Load generator Deployment for Sock Shop
# Simulates realistic user journeys: browse, login, add to cart, checkout

apiVersion: apps/v1
kind: Deployment
metadata:
  name: load-generator
  namespace: sock-shop
spec:
  replicas: 1
  selector:
    matchLabels:
      app: load-generator
  template:
    metadata:
      labels:
        app: load-generator
    spec:
      containers:
        - name: load-generator
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              BASE="http://front-end.sock-shop.svc.cluster.local"
              CARTS="http://carts.sock-shop.svc.cluster.local"

              # Product IDs from catalogue
              PRODUCTS="
              3395a43e-2d88-40de-b95f-e00e1502085b
              510a0d7e-8e83-4193-b483-e27e09ddc34d
              808a2de1-1aaa-4c25-a9b9-6612e8f29a38
              819e1fbf-8b7e-4f6d-811f-693534916a8b
              837ab141-399e-4c1f-9abc-bace40296bac
              a0a4f044-b040-410d-8ead-4de0446aec7e
              d3588630-ad8e-49df-bbd7-3167f7efb246
              zzz4f044-b040-410d-8ead-4de0446aec7e
              "
              
              USER_COUNT=0
              
              log() {
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
              }
              
              # Browse catalogue
              browse() {
                log "ACTION=browse"
                curl -s "$BASE/" > /dev/null
                curl -s "$BASE/catalogue" > /dev/null
                curl -s "$BASE/catalogue?size=5" > /dev/null
                curl -s "$BASE/category.html?tags=sport" > /dev/null
                curl -s "$BASE/catalogue?tags=sport" > /dev/null
                curl -s "$BASE/catalogue/size?tags=sport" > /dev/null
                curl -s "$BASE/tags" > /dev/null

                # View random product detail
                PROD=$(echo "$PRODUCTS" | tr -s ' \n' '\n' | grep -v '^$' | shuf -n1)
                curl -s "$BASE/detail.html?id=$PROD" > /dev/null
                curl -s "$BASE/catalogue/$PROD" > /dev/null
                log "ACTION=view_product product_id=$PROD"
              }
              
              # Register new user - sets global LAST_COOKIE and LAST_CUSTOMER_ID
              LAST_COOKIE=""
              LAST_CUSTOMER_ID=""

              register_and_login() {
                USER_COUNT=$((USER_COUNT + 1))
                USERNAME="testuser${USER_COUNT}_$(date +%s)"
                PASSWORD="password123"
                EMAIL="${USERNAME}@test.com"

                log "ACTION=register username=$USERNAME"
                TMPFILE="/tmp/cookies_$$"
                # Registration returns {"id":"<customer_id>"}
                RESPONSE=$(curl -s -c "$TMPFILE" -X POST "$BASE/register" \
                  -H "Content-Type: application/json" \
                  -d "{\"username\":\"$USERNAME\",\"password\":\"$PASSWORD\",\"email\":\"$EMAIL\",\"firstName\":\"Test\",\"lastName\":\"User\"}")

                # Extract cookie value (7th field in Netscape cookie file)
                LAST_COOKIE=$(grep logged_in "$TMPFILE" 2>/dev/null | awk '{print $7}')
                rm -f "$TMPFILE"

                # Extract customer ID from registration response (supports hex with uppercase and dashes)
                LAST_CUSTOMER_ID=$(echo "$RESPONSE" | grep -o '"id":"[0-9a-fA-F-]*"' | head -1 | cut -d'"' -f4)

                if [ -z "$LAST_COOKIE" ]; then
                  log "ACTION=register_failed username=$USERNAME"
                  LAST_CUSTOMER_ID=""
                  return 1
                fi

                log "ACTION=register_success username=$USERNAME customer_id=$LAST_CUSTOMER_ID"
                return 0
              }
              
              # Add item to cart - calls carts service directly
              add_to_cart() {
                CUSTOMER_ID="$1"
                PROD=$(echo "$PRODUCTS" | tr -s ' \n' '\n' | grep -v '^$' | shuf -n1)

                log "ACTION=add_to_cart customer_id=$CUSTOMER_ID product_id=$PROD"
                if ! curl -s -f -X POST "$CARTS/carts/$CUSTOMER_ID/items" \
                  -H "Content-Type: application/json" \
                  -d "{\"itemId\":\"$PROD\",\"quantity\":1,\"unitPrice\":9.99}" > /dev/null; then
                  log "ACTION=add_to_cart_failed customer_id=$CUSTOMER_ID product_id=$PROD"
                  return 1
                fi
                return 0
              }
              
              # View cart - calls carts service directly
              view_cart() {
                CUSTOMER_ID="$1"
                COOKIE="$2"
                log "ACTION=view_cart customer_id=$CUSTOMER_ID"
                # Call carts service directly to trigger get_items logging
                curl -s "$CARTS/carts/$CUSTOMER_ID/items" > /dev/null
                # Also call front-end for the UI
                curl -s "$BASE/basket.html" -b "logged_in=$COOKIE" > /dev/null
              }
              
              # Checkout
              checkout() {
                COOKIE="$1"
                log "ACTION=checkout"
                curl -s -X POST "$BASE/orders" \
                  -b "logged_in=$COOKIE" > /dev/null
              }
              
              # Delete item from cart - calls carts service directly
              delete_from_cart() {
                CUSTOMER_ID="$1"
                # Get first item ID from cart using grep for reliable JSON extraction
                CART_RESPONSE=$(curl -s "$CARTS/carts/$CUSTOMER_ID/items")
                ITEM_ID=$(echo "$CART_RESPONSE" | grep -o '"itemId":"[^"]*"' | head -1 | cut -d'"' -f4)
                if [ -n "$ITEM_ID" ]; then
                  log "ACTION=delete_from_cart customer_id=$CUSTOMER_ID item_id=$ITEM_ID"
                  curl -s -X DELETE "$CARTS/carts/$CUSTOMER_ID/items/$ITEM_ID" > /dev/null
                else
                  log "ACTION=delete_from_cart customer_id=$CUSTOMER_ID status=cart_empty"
                fi
              }
              
              # View orders
              view_orders() {
                COOKIE="$1"
                log "ACTION=view_orders"
                curl -s "$BASE/orders" -b "logged_in=$COOKIE" > /dev/null
                curl -s "$BASE/customer-orders.html" -b "logged_in=$COOKIE" > /dev/null
              }
              
              # Full user journey
              full_journey() {
                log "JOURNEY=full_purchase starting"

                # Register (sets LAST_COOKIE and LAST_CUSTOMER_ID)
                if ! register_and_login; then
                  log "JOURNEY=full_purchase failed - registration error"
                  return
                fi
                COOKIE="$LAST_COOKIE"
                CUSTOMER_ID="$LAST_CUSTOMER_ID"
                sleep 1

                # Browse
                browse
                sleep 1

                # Add 2-3 items to cart (calls carts service directly)
                ITEMS=$((RANDOM % 2 + 2))
                for i in $(seq 1 $ITEMS); do
                  add_to_cart "$CUSTOMER_ID"
                  sleep 1
                done

                # View cart (calls carts service directly)
                view_cart "$CUSTOMER_ID" "$COOKIE"
                sleep 1

                # Checkout (still via front-end)
                checkout "$COOKIE"
                sleep 1

                # View orders
                view_orders "$COOKIE"

                log "JOURNEY=full_purchase completed"
              }
              
              # Browse only journey
              browse_journey() {
                log "JOURNEY=browse_only starting"
                browse
                sleep 1
                browse
                log "JOURNEY=browse_only completed"
              }
              
              # Cart abandonment journey
              abandon_cart_journey() {
                log "JOURNEY=cart_abandonment starting"

                # Register (sets LAST_COOKIE and LAST_CUSTOMER_ID)
                if ! register_and_login; then
                  log "JOURNEY=cart_abandonment failed - registration error"
                  return
                fi
                COOKIE="$LAST_COOKIE"
                CUSTOMER_ID="$LAST_CUSTOMER_ID"
                sleep 1

                browse
                sleep 1

                # Add items directly to carts service
                add_to_cart "$CUSTOMER_ID"
                sleep 1
                add_to_cart "$CUSTOMER_ID"
                sleep 1

                # View cart (calls carts service directly)
                view_cart "$CUSTOMER_ID" "$COOKIE"

                # Sometimes delete an item before abandoning
                if [ $((RANDOM % 2)) -eq 0 ]; then
                  sleep 1
                  delete_from_cart "$CUSTOMER_ID"
                fi

                # No checkout - abandoned
                log "JOURNEY=cart_abandonment completed"
              }
              
              log "Load generator started"
              
              while true; do
                # Pick random journey
                JOURNEY=$((RANDOM % 10))
                
                if [ $JOURNEY -lt 4 ]; then
                  # 40% - just browsing
                  browse_journey
                elif [ $JOURNEY -lt 7 ]; then
                  # 30% - full purchase
                  full_journey
                else
                  # 30% - cart abandonment
                  abandon_cart_journey
                fi
                
                # Wait between journeys
                WAIT=$((RANDOM % 5 + 3))
                log "Waiting ${WAIT}s before next journey"
                sleep $WAIT
              done
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 128Mi
